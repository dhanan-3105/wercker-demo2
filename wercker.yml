box:
 id: node


# Build definition
build:
  # The steps that will be executed on build
  steps:
    - script:
        code: |
          echo "USERNAME is $USERNAME"
          echo $WERCKER_RUN_ID$IMAGE_BASE
          export IMAGE_ID=$IMAGE_BASE
          echo "Image is $IMAGE_ID"
    - internal/docker-build:
       image-name: $IMAGE_BASE
       dockerfile: Dockerfile1
    - internal/docker-push:
        image: testwerckernode
        repository: $USERNAME/testwerckernode
        username: $USERNAME
        password: $PASSWORD
    - internal/docker-run:
        image: $USERNAME/$IMAGE_BASE
        name: test-container
        port: 80
    - script:
         code: |
           echo "Testing the container.."
           echo "CONTAINER NAME is $CNT_NAME"
           curl -o /var/output.html $CNT_NAME:80
           cat /var/output.html
    - script:
        name: Test the container that we started as a service
        code: |
            if curlOutput=`curl -s $CNT_NAME:80`; then
                export expected=`echo $curlOutput|wc -c`
                if [ $expected -eq 0 ]; then
                    echo "Test failed container gave unexpected response: "
                    exit 1
                else
                    echo "TestPassed : container gave expected response: " 
                    echo "Output is..." $curlOutput
                fi
            else
                echo "Test failed: container did not respond"
                exit 1
            fi
   
   
    - script:
          name: Just-Pushed
          code:
             echo "Pushed the Image to Cloud"
